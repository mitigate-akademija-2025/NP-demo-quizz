<%= form_with(model: quiz) do |form| %>
  <% if quiz.errors.any? %>
    <div style="color: red">
      <h2><%= pluralize(quiz.errors.count, "error") %> prohibited this quiz from being saved:</h2>

      <ul>
        <% quiz.errors.each do |error| %>
          <li><%= error.full_message %></li>
        <% end %>
      </ul>
    </div>
  <% end %>

  <div>
    <%= form.label :title, style: "display: block" %>
    <%= form.text_field :title %>
  </div>

  <div>
    <%= form.label :description, style: "display: block" %>
    <%= form.text_area :description %>
  </div>

  <h3>Questions</h3>
  <div id="questions">
    <%= form.fields_for :questions do |q_form| %>
      <%= render 'question_fields', f: q_form %>
    <% end %>
  </div>

  <div>
    <button type="button" id="add-question">Add question</button>
  </div>

  <div>
    <%= form.submit nil %>
  </div>

  <!-- Template for new question fields, hidden -->
  <div id="question-template" style="display:none;">
    <%= form.fields_for :questions, Question.new, child_index: "new_questions" do |q_form| %>
      <%= render 'question_fields', f: q_form %>
    <% end %>
  </div>

    <!-- Inline JS to handle adding/removing questions -->
  <script data-turbo-eval="true">
    document.addEventListener("turbo:load", function() {
      const addButton = document.getElementById("add-question");
      const questionsDiv = document.getElementById("questions");
      const templateElement = document.getElementById("question-template");

      if (!addButton || !questionsDiv || !templateElement) return;

      const template = templateElement.innerHTML;

      addButton.addEventListener("click", function() {
        const newId = new Date().getTime();
        const regexp = new RegExp("new_questions", "g");
        const newFields = template.replace(regexp, newId);
        questionsDiv.insertAdjacentHTML("beforeend", newFields);
      });

      questionsDiv.addEventListener("click", function(e) {
        if (e.target.classList.contains("remove-question")) {
          e.target.closest(".nested-fields").remove();
        }
      });
    });
  </script>

<% end %>
